name: Dev Release (Firmware)

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 1 * *'
  push:
    branches:
      - master
    paths:
      - board/**


permissions:
  contents: write
  id-token: write
  attestations: write

concurrency:
  group: dev-release-firmware
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Get actions code
        uses: actions/checkout@v4
        with:
          submodules: 'true'
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --force --tags

      - name: Build firmware
        uses: samyarsadat/Pico-Build-Action@v1
        with:
          source_dir: "board"
          output_dir: "../build"
          cmake_args: "-DCMAKE_BUILD_TYPE=Release"

      - name: Prepare fixed filename
        run: |
          mkdir -p dist
          cp build/project/MSRC-RP2040.uf2 dist/MSRC_firmware.uf2

      - name: Generate attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: dist/MSRC_firmware.uf2
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish firmware to Development release
        uses: ncipollo/release-action@v1
        with:
            tag: dev-latest
            name: Development (auto)
            prerelease: true
            allowUpdates: true
            commit: ${{ github.sha }}
            artifacts: dist/MSRC_firmware.uf2
            artifactContentType: application/octet-stream
            replacesArtifacts: true
            generateReleaseNotes: false

      - name: Update release body (firmware section)
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            set -euo pipefail

            # 1) Get release id + current body from tag
            RELEASE_JSON="$(gh api repos/${{ github.repository }}/releases/tags/dev-latest)"
            RELEASE_ID="$(echo "$RELEASE_JSON" | python3 -c 'import sys,json; print(json.load(sys.stdin)["id"])')"
            BODY="$(echo "$RELEASE_JSON" | python3 -c 'import sys,json; print((json.load(sys.stdin).get("body") or ""))')"

            START="<!-- COMPONENT:firmware:start -->"
            END="<!-- COMPONENT:firmware:end -->"

            COMMIT="${{ github.sha }}"
            DATE_UTC="$(date -u +'%Y-%m-%d %H:%M UTC')"

            NEW_SECTION="$START
            **Firmware**
            - commit: \`$COMMIT\`
            - date: $DATE_UTC
            $END"

            UPDATED_BODY="$(python3 - << 'PY'
        import re, os
        body = os.environ["BODY"]
        start = os.environ["START"]
        end = os.environ["END"]
        new_section = os.environ["NEW_SECTION"]

        pattern = re.compile(re.escape(start) + r".*?" + re.escape(end), re.DOTALL)
        if pattern.search(body):
            body2 = pattern.sub(new_section, body)
        else:
            sep = "\n\n---\n\n" if body.strip() else ""
            body2 = body + sep + new_section
        print(body2)
        PY
            )"

            # 2) Patch by release id (this endpoint exists)
            gh api \
            -X PATCH repos/${{ github.repository }}/releases/$RELEASE_ID \
            -f body="$UPDATED_BODY"
        env:
            BODY: ""
            START: "<!-- COMPONENT:firmware:start -->"
            END: "<!-- COMPONENT:firmware:end -->"
            NEW_SECTION: ""